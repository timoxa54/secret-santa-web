<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Panel - Secret Santa</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="container">
        <div class="admin-wrapper">
            <h1>üîê –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å Secret Santa</h1>

            <!-- –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è -->
            <div id="loginSection" class="login-section">
                <h2>–í—Ö–æ–¥ –≤ –∞–¥–º–∏–Ω–∫—É</h2>
                <div class="form-group">
                    <label for="adminPassword">–ü–∞—Ä–æ–ª—å –∞–¥–º–∏–Ω–∞:</label>
                    <input type="password" id="adminPassword" placeholder="–í–≤–µ–¥–∏ –ø–∞—Ä–æ–ª—å">
                    <button class="btn btn-primary" onclick="loginAdmin()">–í–æ–π—Ç–∏</button>
                </div>
                <div id="loginMessage" class="message"></div>
            </div>

            <!-- –ê–¥–º–∏–Ω–∫–∞ (—Å–∫—Ä—ã—Ç–æ –¥–æ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏) -->
            <div id="adminPanel" class="admin-panel" style="display: none;">
                
                <!-- –ö–Ω–æ–ø–∫–∞ –≤—ã—Ö–æ–¥–∞ -->
                <button class="btn btn-secondary" onclick="logoutAdmin()" style="margin-bottom: 20px;">–í—ã–π—Ç–∏</button>

                <!-- –†–∞–∑–¥–µ–ª: –°–ø–∏—Å–æ–∫ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤ -->
                <section class="admin-section">
                    <h2>üìã –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —É—á–∞—Å—Ç–Ω–∏–∫–∞–º–∏</h2>
                    
                    <div class="admin-controls">
                        <button class="btn btn-success" onclick="openAddParticipantForm()">‚ûï –î–æ–±–∞–≤–∏—Ç—å —É—á–∞—Å—Ç–Ω–∏–∫–∞</button>
                        <button class="btn btn-warning" onclick="generateAssignments()">üé≤ –ù–∞–∑–Ω–∞—á–∏—Ç—å –∫–æ–º—É –¥–∞—Ä–∏—Ç—å</button>
                        <button class="btn btn-info" onclick="sendEmails()">üìß –†–∞–∑–æ—Å–ª–∞—Ç—å –ø–∏—Å—å–º–∞</button>
                    </div>

                    <!-- –§–æ—Ä–º–∞ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —É—á–∞—Å—Ç–Ω–∏–∫–∞ -->
                    <div id="addParticipantForm" class="form-wrapper" style="display: none; margin: 20px 0;">
                        <h3>–î–æ–±–∞–≤–∏—Ç—å –Ω–æ–≤–æ–≥–æ —É—á–∞—Å—Ç–Ω–∏–∫–∞</h3>
                        <div class="form-group">
                            <label>–ò–º—è:</label>
                            <input type="text" id="newName" placeholder="–ò–≤–∞–Ω">
                        </div>
                        <div class="form-group">
                            <label>–ü–æ—á—Ç–∞:</label>
                            <input type="email" id="newEmail" placeholder="ivan@example.com">
                        </div>
                        <div class="form-group">
                            <label>–í–∏—à-–ª–∏—Å—Ç:</label>
                            <textarea id="newWishlist" placeholder="–ß—Ç–æ —Ö–æ—á–µ—Ç..." rows="3"></textarea>
                        </div>
                        <button class="btn btn-success" onclick="addParticipant()">–î–æ–±–∞–≤–∏—Ç—å</button>
                        <button class="btn btn-secondary" onclick="closeAddParticipantForm()">–û—Ç–º–µ–Ω–∞</button>
                    </div>

                    <!-- –¢–∞–±–ª–∏—Ü–∞ —Å —É—á–∞—Å—Ç–Ω–∏–∫–∞–º–∏ -->
                    <table id="participantsTable" class="admin-table">
                        <thead>
                            <tr>
                                <th>–ò–º—è</th>
                                <th>–ü–æ—á—Ç–∞</th>
                                <th>–í–∏—à-–ª–∏—Å—Ç</th>
                                <th>–î–∞—Ä–∏—Ç üéÅ</th>
                                <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                            </tr>
                        </thead>
                        <tbody id="tableBody">
                            <!-- –ó–∞–ø–æ–ª–Ω–∏—Ç—Å—è —á–µ—Ä–µ–∑ JavaScript -->
                        </tbody>
                    </table>
                </section>

                <div id="adminMessage" class="message" style="margin-top: 20px;"></div>
            </div>
        </div>
    </div>

    <script>
        // === –ê–î–ú–ò–ù –§–£–ù–ö–¶–ò–ò –î–õ–Ø VERCEL ===
        
        let isLoggedIn = false;
        let participants = [];

        // –ê–í–¢–û–û–ü–†–ï–î–ï–õ–ï–ù–ò–ï API URL (—Ä–∞–±–æ—Ç–∞–µ—Ç –Ω–∞ Vercel!)
        const API_BASE = '/api';

        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏ –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        window.addEventListener('load', () => {
            checkLogin();
        });

        function checkLogin() {
            const token = localStorage.getItem('adminToken');
            if (token) {
                isLoggedIn = true;
                showAdminPanel();
                loadParticipants();
            }
        }

        async function loginAdmin() {
            const password = document.getElementById('adminPassword').value;
            const messageEl = document.getElementById('loginMessage');

            if (!password) {
                messageEl.innerHTML = '‚ùå –í–≤–µ–¥–∏ –ø–∞—Ä–æ–ª—å!';
                messageEl.classList.add('error');
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/admin/login`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ password })
                });

                const data = await response.json();

                if (response.ok) {
                    localStorage.setItem('adminToken', data.token);
                    isLoggedIn = true;
                    messageEl.innerHTML = '‚úÖ –î–æ–±—Ä–æ –ø–æ–∂–∞–ª–æ–≤–∞—Ç—å, –∞–¥–º–∏–Ω!';
                    messageEl.classList.remove('error');
                    messageEl.classList.add('success');
                    setTimeout(showAdminPanel, 500);
                    loadParticipants();
                } else {
                    messageEl.innerHTML = `‚ùå ${data.error || '–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å'}`;
                    messageEl.classList.add('error');
                }
            } catch (error) {
                messageEl.innerHTML = `‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è: ${error.message}`;
                messageEl.classList.add('error');
                console.error('Login error:', error);
            }
        }

        function logoutAdmin() {
            localStorage.removeItem('adminToken');
            isLoggedIn = false;
            document.getElementById('loginSection').style.display = 'block';
            document.getElementById('adminPanel').style.display = 'none';
            document.getElementById('adminPassword').value = '';
            document.getElementById('adminMessage').innerHTML = '';
        }

        function showAdminPanel() {
            document.getElementById('loginSection').style.display = 'none';
            document.getElementById('adminPanel').style.display = 'block';
        }

        async function loadParticipants() {
            const token = localStorage.getItem('adminToken');
            if (!token) return;

            try {
                const response = await fetch(`${API_BASE}/participants`, {
                    headers: { 'Authorization': `Bearer ${token}` }
                });
                const data = await response.json();
                participants = data;
                renderTable();
            } catch (error) {
                console.error('Error loading participants:', error);
                showMessage('‚ùå –û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ —É—á–∞—Å—Ç–Ω–∏–∫–æ–≤: ' + error.message, 'error');
            }
        }

        function renderTable() {
            const tbody = document.getElementById('tableBody');
            tbody.innerHTML = '';

            participants.forEach((p, index) => {
                const row = tbody.insertRow();
                row.innerHTML = `
                    <td>${p.name}</td>
                    <td>${p.email}</td>
                    <td>${p.wishlist || '‚Äî'}</td>
                    <td>${p.assignedTo ? p.assignedTo : '‚ùå –ù–µ –Ω–∞–∑–Ω–∞—á–µ–Ω'}</td>
                    <td>
                        <button class="btn btn-sm btn-warning" onclick="editParticipant(${index})">‚úèÔ∏è –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button>
                        <button class="btn btn-sm btn-danger" onclick="deleteParticipant(${index})">üóëÔ∏è –£–¥–∞–ª–∏—Ç—å</button>
                    </td>
                `;
            });
        }

        function openAddParticipantForm() {
            document.getElementById('addParticipantForm').style.display = 'block';
        }

        function closeAddParticipantForm() {
            document.getElementById('addParticipantForm').style.display = 'none';
            document.getElementById('newName').value = '';
            document.getElementById('newEmail').value = '';
            document.getElementById('newWishlist').value = '';
        }

        async function addParticipant() {
            const token = localStorage.getItem('adminToken');
            const name = document.getElementById('newName').value.trim();
            const email = document.getElementById('newEmail').value.trim();
            const wishlist = document.getElementById('newWishlist').value.trim();

            if (!name || !email) {
                showMessage('‚ùå –ó–∞–ø–æ–ª–Ω–∏ –∏–º—è –∏ –ø–æ—á—Ç—É!', 'error');
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/participants`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ name, email, wishlist })
                });

                if (response.ok) {
                    showMessage('‚úÖ –£—á–∞—Å—Ç–Ω–∏–∫ –¥–æ–±–∞–≤–ª–µ–Ω!');
                    closeAddParticipantForm();
                    loadParticipants();
                } else {
                    const data = await response.json();
                    showMessage('‚ùå ' + (data.error || '–û—à–∏–±–∫–∞'), 'error');
                }
            } catch (error) {
                showMessage('‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è', 'error');
                console.error(error);
            }
        }

        async function editParticipant(index) {
    const p = participants[index];
    
    const newName = prompt('–ù–æ–≤–æ–µ –∏–º—è:', p.name);
    if (newName === null || newName.trim() === '') return;
    
    const newEmail = prompt('–ù–æ–≤–∞—è –ø–æ—á—Ç–∞:', p.email);
    if (newEmail === null || newEmail.trim() === '') return;
    
    const newWishlist = prompt('–ù–æ–≤—ã–π –≤–∏—à-–ª–∏—Å—Ç:', p.wishlist || '');
    
    const token = localStorage.getItem('adminToken');
    
    try {
        // ‚úÖ –û–¢–ü–†–ê–í–õ–Ø–ï–ú –ù–ê –°–ï–†–í–ï–†
        const response = await fetch(`${API_BASE}/participants/${p.id}`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
            },
            body: JSON.stringify({ 
                name: newName.trim(), 
                email: newEmail.trim(), 
                wishlist: newWishlist || '' 
            })
        });

        if (response.ok) {
            // ‚úÖ –û–ë–ù–û–í–õ–Ø–ï–ú –õ–û–ö–ê–õ–¨–ù–´–ï –î–ê–ù–ù–´–ï
            participants[index].name = newName.trim();
            participants[index].email = newEmail.trim();
            participants[index].wishlist = newWishlist || '';
            
            renderTable();
            showMessage('‚úÖ –£—á–∞—Å—Ç–Ω–∏–∫ –æ–±–Ω–æ–≤–ª—ë–Ω!');
        } else {
            const data = await response.json();
            showMessage('‚ùå ' + (data.error || '–û—à–∏–±–∫–∞'), 'error');
        }
    } catch (error) {
        showMessage('‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è', 'error');
        console.error('Edit error:', error);
    }
}


        async function deleteParticipant(index) {
            if (confirm('‚ö†Ô∏è –£–¥–∞–ª–∏—Ç—å —ç—Ç–æ–≥–æ —É—á–∞—Å—Ç–Ω–∏–∫–∞?')) {
                const participant = participants[index];
                const token = localStorage.getItem('adminToken');
                
                try {
                    const response = await fetch(`${API_BASE}/participants/${participant.id || index}`, {
                        method: 'DELETE',
                        headers: { 'Authorization': `Bearer ${token}` }
                    });
                    
                    if (response.ok) {
                        participants = participants.filter((_, i) => i !== index);
                        renderTable();
                        showMessage('‚úÖ –£—á–∞—Å—Ç–Ω–∏–∫ —É–¥–∞–ª—ë–Ω!');
                    } else {
                        const data = await response.json();
                        showMessage('‚ùå ' + (data.error || '–û—à–∏–±–∫–∞'), 'error');
                    }
                } catch (error) {
                    showMessage('‚ùå –û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è', 'error');
                    console.error(error);
                }
            }
        }

        async function generateAssignments() {
            const messageEl = document.getElementById('adminMessage');

            if (participants.length < 2) {
                showMessage('‚ùå –ù—É–∂–Ω–æ –º–∏–Ω–∏–º—É–º 2 —É—á–∞—Å—Ç–Ω–∏–∫–∞!', 'error');
                return;
            }

            try {
                const response = await fetch(`${API_BASE}/generate-assignments`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('adminToken')}`
                    },
                    body: JSON.stringify({ participants })
                });

                const data = await response.json();

                if (response.ok) {
                    participants = data.participants;
                    renderTable();
                    showMessage('‚úÖ –ù–∞–∑–Ω–∞—á–µ–Ω–∏—è —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω—ã!');
                } else {
                    showMessage('‚ùå ' + (data.error || '–û—à–∏–±–∫–∞'), 'error');
                }
            } catch (error) {
                showMessage('‚ùå –û—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏', 'error');
                console.error(error);
            }
        }

        async function sendEmails() {
            const messageEl = document.getElementById('adminMessage');
            const token = localStorage.getItem('adminToken');

            if (!participants.some(p => p.assignedTo)) {
                showMessage('‚ùå –°–Ω–∞—á–∞–ª–∞ –Ω–∞–∑–Ω–∞—á—å –∫–æ–º—É –¥–∞—Ä–∏—Ç—å!', 'error');
                return;
            }

            if (!confirm('üìß –û—Ç–ø—Ä–∞–≤–∏—Ç—å –ø–∏—Å—å–º–∞ –≤—Å–µ–º —É—á–∞—Å—Ç–Ω–∏–∫–∞–º?')) return;

            try {
                const response = await fetch(`${API_BASE}/send-emails`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${token}`
                    },
                    body: JSON.stringify({ participants })
                });

                const data = await response.json();

                if (response.ok) {
                    showMessage('‚úÖ –ü–∏—Å—å–º–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω—ã!');
                } else {
                    showMessage('‚ùå ' + (data.error || '–û—à–∏–±–∫–∞'), 'error');
                }
            } catch (error) {
                showMessage('‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ', 'error');
                console.error(error);
            }
        }

        // –í—Å–ø–æ–º–æ–≥–∞—Ç–µ–ª—å–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è
        function showMessage(text, type = 'info') {
            const messageEl = document.getElementById('adminMessage');
            messageEl.innerHTML = text;
            messageEl.className = `message ${type}`;
            
            if (type === 'success') {
                setTimeout(() => { messageEl.innerHTML = ''; }, 3000);
            }
        }
    </script>
</body>
</html>
